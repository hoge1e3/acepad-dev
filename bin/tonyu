//!run
import {loadScriptTag} from "acepad-os";
import {showIframe} from "acepad-widget";
let compiler;
async function init(){
    if(compiler)return compiler;
    if(typeof requirejs!="function"){
        await loadScriptTag("js/lib/require.js");
    }
    await loadScriptTag("js/reqConf2.js");
    console.log("reqConf2",reqConf);
    reqConf.paths.FS="acepad/FSStub";
    requirejs.config(reqConf);
    window.WebSite={runType:"IDE"};
    const WebSite=await loadScriptTag("WebSite");
    console.log("WS",WebSite);
    let BuilderClient=await loadScriptTag("BuilderClient4Sys");
    const IDEProject=await loadScriptTag("IDEProject");
    let ns2depspec=[
	    {
	        namespace:"kernel", 
	        url: WebSite.compiledKernel/*"Kernel/js/concat.js"*/
	    },
	    {namespace:"mapEditor2", url: WebSite.compiledTools.mapEditor2},
	];
    compiler={
        create(prjdir){
            const ide={
                showError(e){
                    console.error(e);
                },
            };
            const curPrj=IDEProject.create({dir:prjdir,ide});
            const c=new BuilderClient(curPrj ,{
                worker: {
                    ns2depspec, 
                    url: "BuilderWorker.js"/*WORKER_URL*/
                },
                //locale:R.getLocale()
            });
            window.onTonyuDebuggerReady=d=>{
                d.on("runtimeError",e=>{
                    console.log("runt",e.stack.map(s=>s+"").join("\n"));
                    ide.showError(e);
                });
                compiler.curDebugger=d;
                d.requestStop=o=>ide.stop(o);
                d.startWithAutoReload=compiler.startWithAutoReload;
                c.setDebugger(d);
            };
            return c;
        },
        startWithAutoReload(){
            
        },
    };
    return compiler;
}
export async function createCompiler(prjdir){
    return (await init()).create(prjdir);
}
export async function main(prj="."){
    prj=this.resolve(prj);
    const c=await createCompiler(prj);
    await c.fullCompile();
    this.echo("compiled");
    showIframe("debug.html?prj="+prj.path());
}