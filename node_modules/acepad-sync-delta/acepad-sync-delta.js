// acepad-sync-delta
import * as assert from "assert";
function unionKeys() {
    var keys={};
    for (var i=0 ; i<arguments.length ;i++) {
        for (var key in arguments[i]) {keys[key]=1;}
    }
    return keys;
}
export function getDelta(before,after) {
    assert.ok(before,"before");
    assert.ok(after,"after");
    
    //console.log("getDelta",before,after);
    var keys=unionKeys(before,after);
    var res={};
    for (var key in keys) {
        var inb=(key in before),ina=(key in after);
        //console.log("Compare", before[key], after[key], ina, inb);
        if (inb && !ina) {
            // DELETED
            res[key]={lastUpdate:-1, deleted:true};
        } else if (!inb && ina) {
            // CREATED
            res[key]={lastUpdate:after[key].lastUpdate, created:true};
        } else if (Math.abs(
            before[key].lastUpdate-after[key].lastUpdate
        )>1500) {
            // MODIFIED
            res[key]={
                    lastUpdate: after[key].lastUpdate,
                    modified:true
            };
            //console.log("Added", key, before[key].lastUpdate , after[key].lastUpdate)
        }else{
            console.log(
                "unmod",key,
                before[key].lastUpdate,
                after[key].lastUpdate);
        }
    }
    return res;
}
export function getDeltaDelta(local,remote) {
    var keys=unionKeys(local,remote);
    var res={downloads:{},conflicts:{}};
    for (var key in keys) {
        var inl=(key in local),inr=(key in remote);
        if (inr) {
            if(!inl)
                res.downloads[key]=remote[key];
            else  
                res.conflicts[key]=remote[key];
        }
    }
    return res;
}