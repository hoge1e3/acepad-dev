#!run

export function main(){
  let guide;
  let acepad=this.$acepad;
  if(process.env.ACEPAD_DISABLE_AUTOGUTT)return ;
  const style=acepad.editor.container.style;
  function createGuide(e){
    return {
      startTime: performance.now(),
      startPoint: [r.getScrollLeft(), r.getScrollTop()],
      swipeState: null,
      touched:true,
      touchend(e) {
        this.touched=false;
        const endp=[r.getScrollLeft(), r.getScrollTop()];
        const elapsed=performance.now()-this.startTime;
        //console.log("elapsed",elapsed);
        if (elapsed<300&&
        Math.abs(endp[1]-
        this.startPoint[1])>10) {
          this.swipeState={p:endp, startTime:performance.now()};
          this.activated=true;
        }
      },
      activated:false,
      interval() {
        if (!this.activated) return;
        //console.log("x",this.startPoint[0]);
        const p=[r.getScrollLeft(), r.getScrollTop()];
        r.scrollToX(
            this.startPoint[0]*0.05+
            p[0]*0.95);
        if (performance.now()-
        this.swipeState.startTime>300 && 
          Math.abs(this.swipeState.p[1]-p[1])<1&&
          Math.abs(this.startPoint[0]-p[0])<1) {
          //console.log("deact", this.swipeState, p);
          this.activated=false;
        } else {
          try {
            //console.log("el-y",performance.now()-this.swipeState.startTime, 
            //Math.abs(this.swipeState.p[1]-p[1]));
          }catch(e){
            console.error(e);
            this.activated=false;
          }
        }
        this.swipeState.p=p;
      },
    };
  }
  function createGutt(){
    const p=[r.getScrollLeft(), r.getScrollTop()];
    return {
      p,
      dir:0,
      interval(){
        const p=[r.getScrollLeft(), r.getScrollTop()];
        const dx=p[0]-this.p[0];
        if(!this.dir){
          this.dir=dx;
        }
        if(this.dir*dx>0){
          gs.move(dx);
        }
        this.p=p;
      },end(){
        const p=[r.getScrollLeft(), r.getScrollTop()];
        if(p[0]==0){
          gs.move(-gw);
        }
      }
    };
  }
  //this.watch(()=>guide?.activated);
  const r=acepad.getMainEditor().renderer;
  const c=r.container;
  let gut;
  c.addEventListener("touchstart",(e)=>{
    guide=createGuide(e);
    gut=createGutt();
  });
  c.addEventListener("touchend",()=>{
    if (guide) guide.touchend();
    gut?.end();
    gut=null;
  });
  const gs={
    left:0,
    move(by){
      this.left+=by;
      let gl=this.left;
      gl=gl<0?0:gl>gw?gw:gl;
      this.left=gl;
      style.left=`${-gl}px`;
    }
  };
  const gw=80;
  //let pp,gl=0;
  setInterval(()=>{
    gut?.interval();
    if (guide) guide.interval();
  },10);
}
