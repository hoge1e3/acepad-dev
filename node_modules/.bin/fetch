#!run

export async function main(url){
  url=new URL(url,location.href);
  const r=await fetch(url);
  const a=await r.arrayBuffer();
  const fn=(url.pathname.split("/").pop())
  ||"index.html";
  const fnu=uniq(
    fn,await this.resolve().ls());
  const f=this.resolve(fnu);
  if(f.exists())throw new Error(
    `${f} exists`);
  f.bytes(a);
  this.echo("edit",f);
  this.echo("serve",f,url+"");
  
  return [f,url];
}
function uniq(filename, existents) {
  const dot = filename.lastIndexOf(".");
  const name = dot === -1 ? filename : filename.slice(0, dot);
  const ext  = dot === -1 ? ""       : filename.slice(dot);

  // 末尾の "-n" を検出
  const m = name.match(/^(.*?)(?:-(\d+))?$/);
  const base = m[1];
  const start = m[2] ? Number(m[2]) : 0;

  // そのまま使えるなら返す
  if (start === 0 && !existents.includes(filename)) {
    return filename;
  }

  let i = start > 0 ? start : 1;
  let candidate;

  do {
    candidate = `${base}-${i}${ext}`;
    i++;
  } while (existents.includes(candidate));

  return candidate;
}
