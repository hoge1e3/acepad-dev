// @hoge1e3/ref
import {EventHandler} from "@hoge1e3/events";
export function ref(val){
    const r=EventHandler.attachTo({
      get(){
          return val;
      },
      set(n){
        if(val===n)return ;
          const prev=val;
          val=n;
          r.fire("change",{
              prev,val,
          });
      },
      get value(){
          return r.get();
      },
      set value(v){
          return r.set(v);
      }
    });
    return r;
}
export function computed(...args){
    const f=args.pop();
    let val;
    let ti;
    function h(){
        const prev=val;
        val=f(...args.map((r)=>r.get()));
      if(prev!==val){
        res.fire("change",{prev,val});
      }  
      ti=null;
    }
    const req=()=>{
            if(ti!=null)return ;
            ti=setTimeout(h,0);
        };
    for(let r of args){
        r.on("change",req);
    }
    const res=EventHandler.attachTo({
      get(){
          return val;
      },
      get value(){
          return res.get();
      },
    });
    h();
    return res;

}