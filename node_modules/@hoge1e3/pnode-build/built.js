//include alias.js
const pNode=globalThis.pNode;
let ld=[];
let aliases=pNode?.loadedModules();
function es(path,timestamp,a){
  const dependencies=[];
  const dep=(s)=>{
    dependencies.push(ld[s]);
    return ld[s].url;
  };
  const g=a.map((s)=>
    typeof s==="string"?s:dep(s)
  ).join("");
  if (pNode) {
    ld.push(pNode.addPrecompiledESModule(path, timestamp, g, dependencies));
  } else {
    ld.push({url:jsToBlobURL(g)});
  }
}
function b(path){
  ld.push(aliases.getByPath(path));
}
/*0*/b("petit-node");
/*1*/es("/idb/run/node_modules/@acepad/here/here.js",1762595017762,["// @acepad/here\nimport {urlToPath,file as f} from /*\"petit-node\"*/\"",0,"\";\n// imu=import.meta.url\nexport function dir(imu){\n    return file(imu).up();   \n}\nexport function file(imu){\n    if (isFile(imu)) return imu;\n    return f(urlToPath(imu));\n}\nexport function sibling(imu,p){\n    return dir(imu).rel(p);\n}\nexport function isFile(imu) {\n    return imu && (typeof (imu.rel))===\"function\";\n}\n//# sourceURL=file:///idb/run/node_modules/@acepad/here/here.js\n"]);
/*2*/es("/idb/run/node_modules/@hoge1e3/pnode-build/pnode-build.js",1764333447471,["#!run\n// @hoge1e3/pnode-build\nimport {file,sibling} from /*\"@acepad/here\"*/\"",1,"\";\n\nimport * as pNode from /*\"petit-node\"*/\"",0,"\";\n//import {test}  from \"./test.cjs\";\nexport async function main(dst=\"built.js\"){\n  dst=this.resolve(dst);\n  const home=this.resolve(\".\");\n  const mp=home.rel(\"package.json\").obj().main;\n  const target=home.rel(mp).path();\n  return build(target,dst);\n}\nexport async function build(target,dst){\n  //try{\n  const a=pNode.loadedModules();\n  let mod=await compile(target);\n  /*}catch(e){\n    console.error(e.original)\n  }*/\n  console.log(\"pn\",a.getByPath(\"petit-node\"));\n  if (!mod) {\n    throw new Error(`module for ${target} not found`);\n  }\n  let mods=[];\n  let m2id=new WeakMap();\n  //id=number\n  function getId(mod) {\n    if(m2id.has(mod))return m2id.get(mod);\n    for (const d of mod.dependencies) {\n      getId(d);\n    }\n    m2id.set(mod,mods.length);\n    mods.push(mod);\n  }\n  getId(mod);\n  const Re=\"cheediwh\"+\"sifeudi\";\n  const Di=\"jejf\"+\"ksjfi\";\n  let buf=\"\";\n  const q=(d)=>JSON.stringify(d);\n  const idc=(m)=>`/*${getId(m)}*/`;\n  for(let m of mods){\n    if(m.type===\"Builtin\"){\n      buf+=`${idc(m)}b(${q(m.path)});\\n`;\n    }else if(m.type===\"ES\"){\n      let rep=m.generatedCode;\n      for(let d of m.dependencies){\n        if(!d.url){\n          //addURL(d);\n          //console.log(d);\n          throw new Error(`${d.path}(from ${m.path}) no url`);\n        }\n        rep=replaceAll(rep,d.url,\n          Re+Di+m2id.get(d)+Re);\n      }\n      /*rep=rep.replace(/\\bimport\\s*\\.\\s*meta\\s*\\.\\s*url\\b/g,\n      q(m.path));*/\n      const sa=rep.split(Re).map((s)=>\n        s.startsWith(Di)?\n          s.substring(Di.length)-0:s);\n      const ts=file(m.path).lastUpdate();\n      buf+=`${idc(m)}es(${q(m.path)},${ts},${q(sa)});\\n`;\n      console.log(m2id.get(m),m.path, sa);\n    }else if(m.type===\"CJS\"){\n      console.log(m);\n      buf+=`${idc(m)}cjs(${q(m.path)},${q(m.dependencyMap)},function(require, exports, module, __filename, __dirname ){\n${m.generatedCode}\n});\\n`;\n    }\n    //console.log(m2id.get(m),m);\n  }\n  const tmpl=sibling(\n    import.meta.url,\n    \"tmpl.js\").text();\n  dst.text(\n    replaceAll(tmpl,\n    \"//insert\",buf)\n  );\n}\nfunction replaceAll(s,f, t) {  \n  let result = '';\n  let i = 0;\n  while (true) {\n    const j = s.indexOf(f, i);\n    if (j === -1) {\n      result += s.slice(i);\n      break;\n    }\n    result += s.slice(i, j) + t;\n    i = j + f.length;\n  }\n  return result;\n}\nasync function compile(path) {\n  const ent=pNode.resolveEntry(\"ES\", path);\n  const compiler=pNode.ESModuleCompiler.create();\n  const compiled=await compiler.compile(ent);\n  //let u=compiled.url;\n  return compiled;\n}\nfunction requireArguments(file) {\n  const base=file.up();\n  const require=this.requireFunc(base);\n  const exports={};\n  const module={exports};\n  const filename=file.path();\n  const dirname=base.path();\n  return [require, exports, module, filename, dirname ]\n  \n}\n\n//# sourceURL=file:///idb/run/node_modules/@hoge1e3/pnode-build/pnode-build.js\n"]);

import(ld.pop().url);
