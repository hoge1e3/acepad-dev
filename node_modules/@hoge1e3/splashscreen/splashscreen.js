// @hoge1e3/splashscreen
import css from "@acepad/css";
import {generator} from "@hoge1e3/dom";
import {sibling} from "@acepad/here";
let d, dc=0;
const timeout=(t)=>new Promise(s=>setTimeout(s,t));

export function show(text){
    css(sibling(import.meta.url,"splashscreen.css")); 
    if(!d){
        const t=generator();
        d=t.div({class:"splashscreen-container"},
            t.div({class:"splashscreen"}));
        document.body.appendChild(d);
    }
    d.querySelector(".splashscreen").innerText=text;
    //console.log("splashscreen",d.getBoundingClientRect());
}
export function hide(){
    if(d&&d.parentNode){
        d.parentNode.removeChild(d);
    }
    d=null;
}
export function wrap(...a){
    let text="Wait...",f,p;
    while(a.length){
        const e=a.shift();
        if(typeof e==="function"){
            f=e;
        }else if(typeof e==="string"){
            text=e;
        }else if(e&&typeof e.then==="function"){
            p=e;
        }
    }

    async function res(...a){
        try{
            dc++;
            show(text);
            await timeout(1);
            return await (p||f(...a));
        }finally{
            dc--;
            if(dc<=0)hide();
        }
    }
    return p?res():res;
}