// @hoge1e3/dependencies
export function traverse(o, getdeps,opt={}){
    let {key,circular}=opt;
    
    key=key||((e)=>e);
    
    circular=circular||((r)=>{
        console.log("circular",r);
        throw new Error("Circular detected: "+[...r.path,r.k]);
    });
    
    function lp(o,path,memo){
        const k=key(o);
        const result=new Set();
        if(memo.has(k)){
            return memo.get(k);
        }
        if(path.includes(k)) return addAll(
            result,
            circular({result,o,path,k})
        );
        path.push(k);
        for(let e of getdeps(o)){
            result.add(e);
            addAll(result, lp(e,path,memo));
        }
        memo.set(k,result);
        path.pop();
        return result;
    }
    return lp(o,[],new Map());
}
function addAll(s,a){
    for(let e of a)s.add(e);
    return s;
}