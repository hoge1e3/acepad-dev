#!run
/*global EventTarget*/
const timeout=(t)=>new Promise(s=>setTimeout(s,t));
export async function create({
  pass,ws,init,
}){
  const w=new WebSocket(ws);
  globalThis.term_ws=w;

  w.addEventListener("open",(e)=>{
    /*acepad.setCurrentEditor(editor);
    term.textarea.setAttribute("readonly",true);
    term.focus();*/
    console.log("pass",pass);
    w.send(pass+"\r\n");
    //if(init)setTimeout(()=>w.send(init),500);
  });
  let buf="";
  const events=new EventTarget();
  w.addEventListener("message",(e)=>{
    e.data.text().then((s)=>{
      if (typeof buf==="string"){
        buf+=s;
        if (buf.match(/Welcome/)) {
          buf=null;
          console.log("Welcome received!");
          //w.send(`RSZ${term.cols}x${term.rows}`);
          events.dispatchEvent(
          new CustomEvent("login",{
            detail:{}
          }));
          if(init)w.send(init);
        }
      }
      events.dispatchEvent(
        new CustomEvent("receive",{
          detail:{text:s}
        }));
      //term.write(s);  
    });
  });
  w.addEventListener("close",(e)=>{
    events.dispatchEvent(
      new CustomEvent("close",{
    }));
  });
  const instance={
    //widget:wid,
    webSocket:w,
    send(t){
      w.send(t);
    },
    events,
    addEventListener(...a){
      events.addEventListener(...a);
    },
    //terminal:term,
    //addJsonHandler,
  };
  return instance;
}
