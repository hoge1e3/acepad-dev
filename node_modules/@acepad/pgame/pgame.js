// @acepad/pgame
import {show} from "@acepad/widget";
import {sleep} from "@hoge1e3/timeout";
import isPlainObject from "@hoge1e3/is-plain-object";

export function init(){
  const w=show();
  const cv=document.createElement("canvas");
  const W=256,H=192;
  const sta={
    closed:false,
    frame:0,
  };
  w.on("close",()=>{
    sta.closed=true;
  });
  cv.setAttribute("width",256);
  cv.setAttribute("height",192);
  cv.setAttribute("style","width:512px;height:384px;");
  let m={x:128,y:96,p:false};
  w.element.appendChild(cv);
  cv.addEventListener("touchstart",(e)=>{
    const t=e.touches[0];
    m.x=t.clientX/2;
    m.y=t.clientY/2;
    m.p=true;
  });
  cv.addEventListener("touchmove",(e)=>{
    const t=e.touches[0];
    m.x=t.clientX/2;
    m.y=t.clientY/2;
  });
  cv.addEventListener("touchend",(e)=>{
    m.p=false;
  });
  const ctx=cv.getContext("2d");
  const pa=(a,attrs)=>{
    const opt={};
    if(isPlainObject(a[a.length-1])){
      opt=a.pop();
    }
    if(typeof x==="object"){
      if(x.w)w=x.w;
      if(x.h)h=x.h;
      if(x.c)c=(x.c);
    
    
    }

  }
  const r=(x,y,w=16,h=16)=>{
    if(typeof x==="object"){
      if(x.w)w=x.w;
      if(x.h)h=x.h;
      if(x.c)c(x.c);
      ctx.fillRect(x.x,x.y,w,h);
      return ;
    }
    ctx.fillRect(x,y,w,h);
  };
  const g=(x,y)=>{
    
  };
  const c=(o)=>ctx.fillStyle=o;
  const cls=()=>{
    c("black");
    r(0,0,256,192);
  };
  const u=()=>new Promise(s=>
  setTimeout(s,16)
  /*requestAnimationFrame(s)*/);
  const abs=Math.abs.bind(Math);
  const rnd=(a,b)=>{
    if(typeof a!="number"){
      return Math.random();
    }
    if(typeof b!="number"){
      return Math.floor(rnd()*a);
    }
    return rnd(b-a+1)+a;
  };
  const rm=(a,e)=>{
    const i=a.indexOf(e);
    if(i<0)return ;
    return a.splice(i,1);
  };
  class Vec{
    constructor (x,y){
      this.x=x;this.y=y;
    }
    sub(o){
      return v(this.x-o.x,this.y-o.y);
    }
    get len(){
      return (this.x**2+this.y**2)**0.5;
    }
    wrt(to){
      to.x=this.x;
      to.y=this.y;
    }
  }
  const v=Object.assign((x,y)=>{
    if(typeof x==="object"){
      y=x.y;x=x.x;
    }
    return new Vec(x,y);
  },{
  });
  const dist=(a,b)=>v(a).sub(b).len;
  return {r,c,m,cls,u,cv,ctx,abs,dist,v,
  sta,W,H,rnd,rm,widget:w};
}
