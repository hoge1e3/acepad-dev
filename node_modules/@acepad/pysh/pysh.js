// @acepad/pysh
export function tokenizeLines(source) {
  const lines = source.split(/\r?\n/);
  const tokens = [];
  const indentStack = [0];
  let parenLevel = 0; // ← Python 風の括弧レベルカウンタ
  for (let lineNum = 0; lineNum < lines.length; lineNum++) {
    const rawLine = lines[lineNum];
    const isBlank = /^\s*$/.test(rawLine);
    if (isBlank) {
      if (parenLevel === 0) {
        tokens.push({ type: "NEWLINE" });
      }
      continue;
    }
    const indent = rawLine.match(/^\s*/)[0].length;
    const line = rawLine.trim();
    let prevIndent = indentStack[indentStack.length - 1];
    if (parenLevel === 0) {
      console.log(line, indent, prevIndent);
      if (indent > prevIndent) {
        indentStack.push(indent);
        tokens.push({ type: "INDENT", value: indent });
      } else if (indent < prevIndent) {
        while (indent < indentStack[indentStack.length - 1]) {
          indentStack.pop();
          tokens.push({ type: "DEDENT", value: indent });
        }
        if (indent !== indentStack[indentStack.length - 1]) {
          throw new Error(
            `Indentation error at line ${lineNum + 1}: indent=${indent}`
          );
        }
      }
    }

    // --- ここから引用符・括弧を考慮したトークン分解 ---
    const parts = [];
    let i = 0;
    const L = line.length;

    while (i < L) {
      const ch = line[i];

      // 1. 引用符（"..."）処理
      if (ch === '"') {
        i++;
        let buf = "";
        while (i < L) {
          if (line[i] === '\\' && i + 1 < L) {
            buf += line[i + 1];
            i += 2;
          } else if (line[i] === '"') {
            i++;
            break;
          } else {
            buf += line[i];
            i++;
          }
        }
        parts.push(buf);
        continue;
      }

      // 2. 括弧処理（開くなら parenLevel++、閉じるなら parenLevel--）
      if ("([{".includes(ch)) {
        parts.push(ch);
        parenLevel++;
        i++;
        continue;
      }
      if (")]}".includes(ch)) {
        parts.push(ch);
        parenLevel = Math.max(0, parenLevel - 1);
        i++;
        continue;
      }

      // 3. 空白
      if (/\s/.test(ch)) {
        i++;
        continue;
      }

      // 4. 通常の単語
      let start = i;
      while (i < L && !/\s/.test(line[i]) && !"()[]{}".includes(line[i])) {
        i++;
      }
      parts.push(line.slice(start, i));
    }

    // --- parts を WORD として吐く ---
    for (const p of parts) {
      tokens.push({ type: "WORD", value: p });
    }

    // NEWLINE（parenLevel > 0 のときはスキップ）
    if (parenLevel === 0) {
      tokens.push({ type: "NEWLINE" });
    }
  }

  // 残った DEDENT をすべて吐く（parenLevel は影響しない）
  while (indentStack.length > 1) {
    indentStack.pop();
    tokens.push({ type: "DEDENT" });
  }

  return tokens;
}