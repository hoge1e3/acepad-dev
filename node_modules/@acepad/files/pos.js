import {getRoot,getMetaRoot} from "@acepad/shell";
import {sessionInfo} from "@acepad/sessions";
import {locate} from "@acepad/cursor";
function file(f){
    const root=getRoot(f);
    const dir=f.up();
    return getMetaRoot(dir).rel(
        dir.relPath(root)
    ).rel("pos.json");
}
export function get(f){
    let row=1;
    let column=1;
    try{
        const o=file(f);
        const d=o.obj()[f.name()];
        row=d.row-0;
        column=d.column-0;
    }catch(e){
        console.error(e);
    }
    return {row,column};
}
export function set(f,{row,column}){
    let o;
    try{
        o=file(f);
        if(!o.exists())o.obj({});
        const oo=o.obj();
        let d=oo[f.name()];
        if(!d){
            d={};
            oo[f.name()]=d;
        }
        d.row=row;
        d.column=column;
        o.obj(oo);
    }catch(e){
        console.error(e);
        o.obj({});
    }
}
    

const run=Symbol("autoSync");
export function initAutoSave(acepad){
    const {getMainEditor}=acepad;
    if(acepad[run]!=null)return ;
    const editor=getMainEditor();
    acepad[run]=setInterval(()=>{
        const si=sessionInfo(editor.session);
        let f=si.file;
        if(!f)return;
        if(f.isDir())return ;
        const p=locate.get(editor.session);
        set(f,p);
    },1000);
}
