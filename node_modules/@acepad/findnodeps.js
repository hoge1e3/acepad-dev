#!run
import {PackageJson} from "@acepad/npm";
export async function main(){
  const f=PackageJson.find("@acepad/with-fs",this.resolve("."));
  const skip={"petit-node":1, "assert":1};
  const shown=new Set();
  async function traverse(pkg) {
    for (let k in pkg.obj.dependencies) {
      if (skip[k]) continue;
      try {
        const d=PackageJson.find(k, pkg.dir);
        if (d==null) throw new Error(k+" is not found from "+pkg.dir);
        await traverse(d);
      }catch(e) {
        console.error(e);
      }
    }
    await show(pkg);
  }
  async function show(pkg) {
    const o=pkg.obj;
    console.log(o.name, o.version);
    if(shown.has(o.name)) return;
    shown.add(o.name);
    const url=`https://cdn.jsdelivr.net/npm/${o.name}/package.json`;
    try {
      const r=await fetch(url);
      console.log(await r.text());
    }catch(e) {
      console.error(e);  
    }
  }
  await traverse(f);
  /*  for (let f of this.resolve(".").listFiles()) {
        if (!f.isDir()) continue;
        if (!f.rel("package.json").exists()) continue;
        //this.echo(f);
        const o=f.rel("package.json").obj();
        if (Object.keys(o.dependencies||{}).length==0) {
          this.echo(f);
        }
    }*/
}
