// acepad-mode-shell
import {createMode} from "@acepad/mode";
import {sessionInfo} from "@acepad/sessions";
let inited;
export function init(){
  if(inited)return;
  inited=true;
  function getContext(editor,session,pos,prefix){
    const line=session.getLine(pos.row);
    const si=sessionInfo(session);
    //console.log(si.sh===sh);
    const sh=si.sh;
    if(!line.match(/^sh:/))return "file";
    let picked=stripPrompt(line);
    let c=pos.column-(line.length-picked.length);
    let secondArg=picked.substring(0, c-prefix.length).match(/\s$/);
    if(secondArg)return "file";
    else return "command";
  }
  function stripPrompt(line){
    return line.replace(/^sh:\s*/,"");
  }
  async function getCompletions(editor, session, pos, prefix,) {
    const si=sessionInfo(session);
    const sh=si.sh;
    const sc=(w)=>w.startsWith(prefix)?1000000:10000;
    const ctx=getContext(editor,session,pos,prefix);
    switch(ctx){
    case "file":
      //filter is not function. why!
      return (sh.getcwd().ls()).map(n=>({
        caption: n,
        value: n+" ",
        score: sc(n),
        meta: "file"
      })).filter(({score})=>score);
    case "command":
      let cl=sh.commandList();
      return (cl.map(n=>({
        caption: n,
        value: n+" ",
        score: sc(n),
        meta: "command"
      })).filter(({score})=>score));
    }
  }
  createMode("shell",{
    highlights:[
      {
      regex:/^sh:/,
      css: "color:blue; font-weight:bold;"
      },
      {
      regex:/^new:/,
      css: "color:#00c; font-weight:bold;"
      },
      {
      regex:/^\..+$/,
      css: "color:gray; "
      },
      {
      regex:/^.*\/$/,
      css: "color:green; "
      },
      //ğŸ“
      {
      regex:/.*ğŸ“$/,
      css: "color:#000; font-weight:bold;"
      },
    ],
    getCompletions
  });
}
