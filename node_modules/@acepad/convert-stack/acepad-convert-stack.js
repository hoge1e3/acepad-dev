#!run
// acepad-convert-stack

import {loadedModules} from "petit-node";
//import FS from "@hoge1e3/fs";
let _convertRequired;
function convertRequired() {
    if (typeof _convertRequired==="boolean")return _convertRequired;
    const mesg="this is test message";
    try {
        throw new Error(mesg);
    } catch(e) {
        if (e.stack.includes(mesg)) {
            _convertRequired=false;
        } else {
            _convertRequired=true;
        }
    }
}

export const convertStack=(e, force=false)=>{
    if (!force && !convertRequired()) return e;
    if(!e) return e;
    if (typeof e.stack!=="string") return e;
    for (let m of loadedModules()) {
        if (!m.url)continue;
        let i=e.stack.indexOf(m.url);
        if (i<0) continue;
        e.stack=e.stack.substring(0,i)+
        (m.entry?"file://":"")+m.path+e.stack.substring(i+m.url.length);
    }
    e.stack=e.message+"\n"+e.stack;
    return e;
};    
/*
const o=("os" in FS) && FS.os;
export const convertStack=(e)=>{
    if(!o)return e;
    if(e && typeof e.stack==="string"){
        e.stack=o.convertStack(e.stack);
        return e;
    }
    return o.convertStack(e);
}    ;    
export async function main(){
    const e=`
    SyntaxError: The requested module 'blob:https://bitarrow3.eplang.jp/2fde3d1b-4211-48f0-bda7-99f47d762117' does not provide an export named 'a2'
`;
    this.echo(c.call(this,e));

function c(stack){
    for(let m of loadedModules()){
        let i;
        const path=m.file.path();
        if(path.includes(m.url))continue;
        this.echo(path,m.url);
        while((i=stack.indexOf(m.url))>=0){
            stack=stack.substring(0,i)+
                path+stack.substring(i+m.url.length);
        }
        //console.log(m.entry.file.path(),m.url);
        //r.push(m.file.path());
    }
    return stack;
    
}
*/