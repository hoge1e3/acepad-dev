// @acepad/httpd
import {setListener} from "@acepad/tagged-listener";
export async function serve(path,handler){
  //await this.sweval("./atsw.js");
  //await this.sleep(0.5);
  
  const reg= await navigator.serviceWorker.ready;
  reg.active.postMessage(
    {
      type:"serve",
      path
    }
  );
  setListener(
  navigator.serviceWorker,
  'message',"serve-"+path,
  async (e) => {
    const { type, request } = e.data||{};
    let body=null;
    let status = 200;
    if(!request)return ;
    const response= {
      status,
      body,
      headers: {
        'Content-Type': 'text/plain;charset=utf8'
      },
      writeHead(status,headers) {
      
        this.status=status;
        this.headers=headers;
      },
      end(body){ 
        this.body=body;
      }
    };
    await handler(request,response);
    reg.active.postMessage({
      type, response:{
        status:response.status,
        body:response.body,
        headers:response.headers,
        
      } 
    });
  });
  //await this.sleep(0.5);
  const url=reg.scope+path;
  return url;
  
}