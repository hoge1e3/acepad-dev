/*global self*/
self.addMessageHandler("serve",(event)=>{
  const {path}=event.data;
  const client = event.source;
  self.addUrlHandler(path,async(event)=>{
    event.respondWith(handle(event));
    async function handle(event) {
      return new Promise((resolve) => {
        const type=crypto.randomUUID();
        self.addMessageHandler(type,(e)=>{
          const { response } = e.data;
          resolve(new Response(response.body, response));
          self.removeMessageHandler(type);
          
        });
        //console.log("post",event.request.url);
        client.postMessage(
          {
            type,
            request: {
              url: event.request.url,
              method: event.request.method
            }
          },
        );
      });
    }
    
  });
});