#!run
import * as rpc from 
    "https://unpkg.com/@hoge1e3/rpc@latest/dist/index.js";
import * as sw from "@hoge1e3/str2worker";

export function server(w){
    rpc.proxy.server(w,"console",[],{
        log:console.log.bind(console),
        error:console.error.bind(console),
    });
}
export function client(){
    const c=rpc.proxy.client(self,"console");
    //console.log("test124");
    const old={
        log:console.log,
        error:console.error,
    };
    console.log=(...a)=>{
        c.log(...a);
        old.log.apply(console,a);
    };
    console.error=(...a)=>{
        c.log(...a);
        old.error.apply(console,a);
    };
    
    return c;
}
export function main(){
    
    const w=sw.create(`
import * as rpc from 
    "https://unpkg.com/@hoge1e3/rpc@latest/dist/index.js";
self.postMessage("aaa");
const console=rpc.proxy.client(self,"console");
console.log("test124");
    `);    
    // this does not receive any message
    //(sw.create creates worker from sting source using blob url)
    /*const w=sw.create(`
    self.postMessage("aaa");
`);*/
    rpc.proxy.server(w,"console",[],{
        log:console.log.bind(console),
        error:console.error.bind(console),
    });
    /*w.addEventListener("message",
    (e)=>console.log("mesg",e.data));*/
    //window.postMessage("bbb");
    this.echo("done",w);
}