#!run
const p=`@hoge1e3/events
@hoge1e3/fs
@hoge1e3/fs-nw
@hoge1e3/rpc
@hoge1e3/default-map
@hoge1e3/counter
@hoge1e3/object-id
@hoge1e3/sfile
@hoge1e3/fs2
@hoge1e3/psync
@hoge1e3/util
@hoge1e3/assert
@hoge1e3/keyset
@hoge1e3/dom
@hoge1e3/dom-updater
@hoge1e3/unload
@hoge1e3/dependencies`.split("\n").map(s=>s+"/");
import {dir} from "@acepad/here";
export async function maino(){
    const h=dir(import.meta.url);
    //checkattrs(h);
    //return;
    for(let d of h.
    rel("@hoge1e3").listFiles()){
        const r=d.relPath(h);
        if (!p.includes(r)){
            this.echo("x",r);
            this.echo("deps",...
                Object.keys(
                d.rel("package.json").
                obj().dependencies||{}));         
            this.echo("a",...checkattrs(d));
        }else{
            this.echo("o",d);
        }
    }
}
export async function main(){
    const sh=this;
    const d=sh.cwd();
    const miss=checkattrs(d);
    const re=d.rel("README.md").exists();
    if(miss.length==0&&re){
        sh.echo("perfect");
        return;
    }
    const pr=`
The attached zip file is a npm package
but there is some missing stuffs
${miss.length==0?"":`*.The following attributes in package.json: ${[...miss].join(", ")}`}
${!miss.has("types")?"":`* types.d.ts is missing`}
${re?"":"* README.md is missing"}
Analyse content of files(especially *.js file) and add missing stuffs
The answer should be in JSON format 
where the keys are pathes of changed files
and their values are file content.
`;
    sh.echo(pr);
}
const tmpl={
    author:"hoge1e3",
    repository:"https://github.com/hoge1e3/acepad-dev/",
    license:"MIT",
};
const pkgattrs="main name type version dependencies types repository description license author keywords".
split(" ");
const optattrs="devDependencies files bin scripts".split(" ");
function checkattrs(d){
    const s=new Set();
    /*for(let f of h.recursive()){
        if(f.name()!="package.json")continue;*/
        const f=d.rel("package.json");
        const o=f.obj();
        for(let k of pkgattrs){
            if(!(k in o)){
                if(k in tmpl){
                    o[k]=tmpl[k];
                    f.obj(o);
                }else{
                s.add(k);
                }
            }
        }
        //Object.keys(o).forEach(k=>s.add(k));
    //}
    return s;
    //console.log(...s);
    
}