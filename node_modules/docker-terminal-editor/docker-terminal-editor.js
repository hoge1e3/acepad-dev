// docker-terminal-editor
/*global $*/
const timeout=(t)=>new Promise(s=>setTimeout(s,t));
import {showWidget} from "@acepad/widget";
import {modeMap} from "@acepad/files";
import FS from "@hoge1e3/fs";

export function initHandler(wst){
    console.log("handler added");
    wst.addJsonHandler((e)=>{
        console.log("recv json",e.data);
        if(e.data.cmd=="edit"){
            return doEdit(e);
        }
    });
}
function doEdit({widget,data,webSocket}){
    widget.hide();
    const wid=showWidget();
    const editore=$("<div>").
    appendTo(wid.element).
    css({width:"100%",height:"90%"});
    const file=data.file;
    const ext=FS.PathUtil.ext(file);
    const editor=window.acepad.edit(editore[0]);
    editor.session.setValue(data.content);
    editor.session.setMode(modeMap[ext]);
    wid.on("close",()=>{
        widget.show();
        const content=editor.session.getValue();
        if(content===data.content){
            webSocket.send(JSON.stringify({})+"\n");
            return ;
        }
        webSocket.send(JSON.stringify({content,file})+"\n");
    });
    return true;
}
