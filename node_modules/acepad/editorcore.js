import {isMobile} from './platform.js';
import {setEditor,getConfig,setCurrentEditor,getCurrentEditor} from './states.js';
import {parseCommands,attachAcepadEditConmands} from './command.js';
import {initKeypad} from './keypad.js';
import {doClick} from './keyhandler.js';

export function edit(e){
    const ace=window.ace;
    let editor = e instanceof ace.Editor ? e 
    :ace.edit(e);
    editor.setOptions({
        enableLiveAutocompletion: true,
        scrollPastEnd:0.6,
    });
    editor.setFontSize(15);
    const kd=()=>{
        if(isMobile())selectKeyDevice("s",editor);
        else selectKeyDevice("p",editor);
    };
    kd();
    //editor.textInput.getElement().setAttribute("readonly",true);
    editor.on("focus",()=>{
        kd();
        setCurrentEditor(editor);
    });
    let {commands}=getConfig();
    commands=parseCommands(commands);
    for (let k in commands) {
        editor.commands.addCommand(commands[k]);
    }
    return editor;
}
export function initEditor(){
    const ace=window.ace;
    window.ace_language_tools=ace.require("ace/ext/language_tools");
    const editor=edit("editor");
    setEditor(editor);
    return editor;
}
export function initCore(){
    initEditor();
    initKeypad({pressHandler:doClick});
}
export function selectKeyDevice(ps ,editor){
    //"physical" or "screen"
    if(!editor)editor=getCurrentEditor();
    if(!ps){
        ps=isMobile()?"s":"p";
    }
    if(ps.match(/^s/)){
        editor.textInput.getElement().setAttribute("readonly",true);
        attachAcepadEditConmands(editor);
    }else
    editor.textInput.getElement().removeAttribute("readonly");
}
